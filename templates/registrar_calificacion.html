<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <script id="datos-json" type="application/json">
    {
      "materias": {{ materias | tojson | safe }},
      "alumnos": {{ alumnos | tojson | safe }}
    }
  </script>
  <title>Registrar Calificaci√≥n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/parametros.css') }}">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .acordeon-boton {
      display: inline-flex;
      align-items: center;
      background-color: #f7f9fc;
      color: #333;
      padding: 8px 20px;
      border-radius: 30px;
      border: 1px solid #ccc;
      font-weight: 500;
      text-decoration: none;
      transition: background-color 0.3s, border-color 0.3s;
      cursor: pointer;
    }
    .acordeon-boton:hover {
      background-color: #e3f2fd;
      border-color: #4a90e2;
    }
    .rotate-icon {
      transition: transform 0.3s ease;
      margin-left: 8px;
    }
    .rotado {
      transform: rotate(180deg);
    }
    .fila-clara {
      background-color: #abd7ec;
      color: #000;
    }
    .fila-suave {
      background-color: #c7e6f7;
      color: #000;
    }

    .invalid-feedback {
      display: none;
      color: #dc3545;
      font-size: 0.875em;
      margin-top: 5px;
    }

    select:invalid + .invalid-feedback {
      display: block;
    }
  </style>
</head>
<body>
<div class="container mt-4">

  <h2 class="text-center mb-4">Registro de Alumnos y Calificaciones</h2>

  {% if mensaje %}
  <div class="alert alert-info alert-dismissible fade show text-center" role="alert">
    {{ mensaje }}
    <button type="button" class="close" data-dismiss="alert" aria-label="Cerrar">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  {% endif %}

<!-- ‚úÖ FORMULARIO: A√±adir o actualizar alumno -->
<h4>‚ûï A√±adir o actualizar alumno</h4>
<form method="POST" action="{{ url_for('datos_alumnos') }}" class="mb-5">
  <div class="form-row">
    <div class="form-group col-md-4">
      <label for="nombre">Nombre:</label>
      <input type="text" name="nombre" id="nombre" class="form-control" required>
    </div>
    <div class="form-group col-md-3">
      <label for="matricula">Matr√≠cula:</label>
      <input type="text" name="matricula" id="matricula" class="form-control" required>
    </div>
    <div class="form-group col-md-3">
      <label for="licenciatura">Licenciatura:</label>
      <select name="licenciatura" id="licenciatura" class="form-control" required>
        <option value="Matematicas">Matem√°ticas</option>
        <option value="Primaria">Primaria</option>
        <option value="Espanol">Espa√±ol</option>
      </select>
    </div>
    <div class="form-group col-md-2">
      <label for="semestre">Semestre:</label>
      <select name="semestre" id="semestre" class="form-control" required>
        {% for s in range(1, 8) %}
        <option value="{{ s }}">{{ s }}¬∞</option>
        {% endfor %}
      </select>
    </div>
  </div>
  <button type="submit" class="btn btn-primary btn-block">Guardar Alumno</button>
</form>

<!-- ‚úÖ FORMULARIO: Registrar calificaci√≥n por pasos -->
<h4 class="mt-5">üìù Registrar calificaci√≥n</h4>

<!-- Paso 1: Licenciatura -->
<div id="paso1" class="paso activo">
  <label for="licenciatura_filtro">üéì Selecciona una licenciatura</label>
  <select id="licenciatura_filtro" class="form-control" required>
    <option value="">Selecciona una licenciatura</option>
    <option value="Matem√°ticas">Licenciatura en Ense√±anza y Aprendizaje de las Matem√°ticas</option>
    <option value="Primaria">Licenciatura en Educaci√≥n primaria</option>
    <option value="Espa√±ol">Licenciatura en Ense√±anza y Aprendizaje del Espa√±ol</option>
  </select>
</div>

<!-- Paso 2: Semestre -->
<div id="paso2" class="paso">
  <label for="semestre_filtro">üìò Selecciona un semestre</label>
  <select id="semestre_filtro" class="form-control" required disabled>
    <option value="">Selecciona un semestre</option>
  </select>
</div>

<!-- Paso 3: Materia -->
<div id="paso3" class="paso">
  <label for="materia">üìö Selecciona un curso</label>
  <select id="materia" class="form-control" required disabled>
    <option value="" disabled selected>Seleccione un curso de la lista</option>
  </select>
  <div id="error-materia" class="invalid-feedback">
    ‚ö†Ô∏è Debes seleccionar un curso para continuar.
  </div>
</div>

<!-- Paso 4: Registrar calificaci√≥n -->
<div id="paso4" class="paso">
  <form id="form-calificacion">
    <div class="form-group">
      <label for="alumno">üë®‚Äçüéì Selecciona un alumno</label>
      <select name="alumno_id" id="alumno" class="form-control" required>
        <option value="">Selecciona un alumno</option>
      </select>
    </div>
    <div class="form-group">
      <label for="calificacion">Calificaci√≥n:</label>
      <input type="number" name="calificacion" id="calificacion" class="form-control" min="0" max="100" required>
    </div>
    <!-- Estos inputs ocultos se llenar√°n desde JS si es necesario -->
    <input type="hidden" name="materia_id" id="materia_hidden">
    <input type="hidden" name="semestre" id="semestre_hidden">
    <input type="hidden" name="licenciatura" id="licenciatura_hidden">

    <button type="submit" class="btn btn-success btn-block">Guardar Calificaci√≥n</button>
  </form>
</div>

<!-- Cat√°logo de alumnos -->
<hr class="my-5">
<h4 class="mb-4 text-dark">üìö Cat√°logo de Alumnos</h4>
<div id="alumnos-por-licenciatura">
  <div id="alerta-eliminado" class="alert alert-success text-center" style="display: none;">
    Alumno eliminado con √©xito.
  </div>

  {% for licenciatura, alumnos_por_semestre in alumnos_agrupados.items() %}
  <div class="card mb-3">
    <div class="card-header bg-dark d-flex justify-content-between align-items-center text-white">
      <div>
        <a class="acordeon-boton text-dark"
           data-toggle="collapse"
           href="#{{ licenciatura | replace(' ', '_') }}">
          {{ licenciatura }} <span class="rotate-icon ml-2">&#9662;</span>
        </a>
      </div>
      <div class="lupa-area d-flex align-items-center position-relative">
          <button type="button"
                class="btn btn-sm btn-warning actualizar-semestre"
                data-licenciatura="{{ licenciatura }}"
                title="Actualizar semestre de todos los alumnos de esta licenciatura">
          <i class="fas fa-arrow-up"></i> Actualizar semestre
          </button>
        <button type="button"
                class="btn btn-sm btn-light lupa-buscar"
                data-licenciatura="{{ licenciatura | replace(' ', '_') }}"
                aria-label="Buscar calificaciones de {{ licenciatura }}"
                title="Buscar">
          <i class="fas fa-search"></i>
        </button>
        <div class="buscador-licenciatura position-absolute ml-2"
             id="buscador-{{ licenciatura | replace(' ', '_') }}">
          <div class="input-group input-group-sm rounded-pill shadow bg-white">
            <input type="text"
                   class="form-control border-0 px-3 input-busqueda-local"
                   data-licenciatura="{{ licenciatura | replace(' ', '_') }}"
                   placeholder="Buscar en {{ licenciatura }}">
            <div class="input-group-append">
              <span class="input-group-text bg-white border-0">
                <i class="fas fa-user text-dark"></i>
              </span>
            </div>
          </div>
          <div class="alert alert-warning mt-2 py-1 px-2 text-center small mb-0 sin-resultados-local"
               style="display: none;">
            No se encontr√≥ ning√∫n alumno en {{ licenciatura }}.
          </div>
        </div>
      </div>
    </div>

    <div id="{{ licenciatura | replace(' ', '_') }}" class="collapse">
      <div class="card-body">
        {% for semestre, alumnos in alumnos_por_semestre.items() %}
        <div class="bg-secondary text-white px-3 py-2 mb-0">
          <h6 class="mb-0">
            <a class="acordeon-boton text-dark"
               data-toggle="collapse"
               href="#{{ licenciatura | replace(' ', '_') }}_{{ semestre }}">
              Semestre {{ semestre }} <span class="rotate-icon">&#9662;</span>
            </a>
          </h6>
        </div>
        <div id="{{ licenciatura | replace(' ', '_') }}_{{ semestre }}" class="collapse">
          <table class="table mb-4">
            <thead class="thead-light">
              <tr>
                <th>Nombre</th>
                <th>Matr√≠cula</th>
                <th style="width: 80px;">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for alumno in alumnos %}
              <tr id="alumno-{{ alumno.id }}"
                  class="fila-alumno fila-{{ licenciatura | replace(' ', '_') }} {% if loop.index0 % 2 == 0 %}fila-clara{% else %}fila-suave{% endif %}">
                <td>{{ alumno.nombre }}</td>
                <td>{{ alumno.matricula }}</td>
                <td class="text-center">
                  <a href="{{ url_for('ver_historial_estudiante', estudiante_id=alumno.id) }}"
                     class="btn btn-sm btn-info"
                     title="Ver historial acad√©mico">
                    <i class="fas fa-book"></i>
                  </a>
                  <button type="button"
                          class="btn btn-sm btn-light eliminar-alumno"
                          data-id="{{ alumno.id }}"
                          title="Eliminar alumno"
                          aria-label="Eliminar alumno">
                    <i class="fas fa-trash-alt text-danger"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<style>
.buscador-licenciatura {
  right: 0;
  width: 0;
  opacity: 0;
  overflow: hidden;
  transition: all 0.4s ease;
  z-index: 10;
}
.buscador-licenciatura.activo {
  width: 280px;
  opacity: 1;
}

.paso {
  opacity: 0;
  transform: translateY(10px);
  transition: opacity 0.5s ease, transform 0.5s ease;
  margin-bottom: 20px;
}
.paso.activo {
  opacity: 1;
  transform: translateY(0);
}
</style>

<script>
$(function () {
  function normalizar(texto) {
  return texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
  }
  let animacionActiva = false;
  // ============================
  // üéì FILTRO DIN√ÅMICO DE CALIFICACI√ìN
  // ============================
  const rawJson = document.getElementById('datos-json').textContent;
  const datos = JSON.parse(rawJson);
  const todasMaterias = datos.materias;
  const todosAlumnos = datos.alumnos;

  $('#licenciatura_filtro').on('change', function () {
    const lic = $(this).val();
    $('#semestre_filtro').prop('disabled', !lic);
    $('#paso2').addClass('activo');
    $('#paso3, #paso4').removeClass('activo');
    $('#materia').prop('disabled', true).html('<option value="">Seleccione una materia</option>');
    $('#alumno').html('<option value="">Seleccione un alumno</option>');
    $('#registro-calificacion').hide();

    let opciones = '<option value="">Selecciona un semestre</option>';
    for (let i = 1; i <= 7; i++) {
      opciones += `<option value="${i}">${i}¬∞ semestre</option>`;
    }
    $('#semestre_filtro').html(opciones);
  });

  $('#semestre_filtro').on('change', function () {
    const lic = $('#licenciatura_filtro').val();
    const semestre = $(this).val();
    if (!lic || !semestre) return;

    $('#materia').prop('disabled', false);
    $('#paso3').addClass('activo');

    const materiasFiltradas = todasMaterias.filter(m =>
      m.licenciatura === lic && parseInt(m.semestre) === parseInt(semestre)
    );

    let opciones = '<option value="">Seleccione un curso</option>';
    materiasFiltradas.forEach(m => {
      opciones += `<option value="${m.id}">${m.nombre}</option>`;
    });

    $('#materia').html(opciones);
    $('#registro-calificacion').hide();
  });

  $('#materia').on('change', function () {
    const materiaId = $(this).val();
    const semestre = $('#semestre_filtro').val();
    const licenciatura = $('#licenciatura_filtro').val();
    if (!materiaId || !semestre || !licenciatura) return;

    $('#materia_hidden').val(materiaId);
    $('#semestre_hidden').val(semestre);
    $('#licenciatura_hidden').val(licenciatura);

    const alumnosFiltrados = todosAlumnos.filter(a =>
      a.licenciatura === licenciatura && parseInt(a.semestre) === parseInt(semestre)
    );

    let opciones = '<option value="">Selecciona un alumno</option>';
    alumnosFiltrados.forEach(a => {
      opciones += `<option value="${a.id}">${a.nombre} (${a.matricula})</option>`;
    });

    $('#alumno').html(opciones);
    $('#paso4').addClass('activo');
    $('#registro-calificacion').fadeIn();
  });

  $('#paso4 form').on('submit', function (e) {
    e.preventDefault();

    const alumnoId = $('#alumno').val();
    const materiaId = $('#materia').val();
    const calificacion = $('#calificacion').val();
    const resumen = `
      ¬øDeseas guardar esta calificaci√≥n?\n
      üéì Licenciatura: ${$('#licenciatura_filtro option:selected').text()}
      üìò Semestre: ${$('#semestre_filtro option:selected').text()}
      üìö Materia: ${$('#materia option:selected').text()}
      üë®‚Äçüéì Alumno: ${$('#alumno option:selected').text()}
      üìù Calificaci√≥n: ${calificacion}
    `;

    if (!alumnoId || !materiaId || calificacion === '') {
      alert('‚ö†Ô∏è Completa todos los campos antes de guardar.');
      return;
    }

    if (isNaN(calificacion) || calificacion < 0 || calificacion > 10) {
      alert('‚ö†Ô∏è La calificaci√≥n debe estar entre 0 y 10.');
      return;
    }

    if (!confirm(resumen)) return;

    fetch('/guardar-calificacion', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: new URLSearchParams({
        alumno_id: alumnoId,
        materia_id: materiaId,
        calificacion: calificacion
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.exito) {
        alert(data.mensaje);
        $('#alumno').val('');
        $('#calificacion').val('');
      } else {
        alert(data.mensaje);
      }
    })
    .catch(() => alert('‚ùå No se pudo conectar con el servidor.'));
  });
});

// ============================
// üïµÔ∏è‚Äç‚ôÇÔ∏è BUSCADOR LOCAL DE ALUMNOS
// ============================

let animacionActiva = true;

$('.lupa-buscar').on('click', function (e) {
  e.stopPropagation();
  const lic = $(this).data('licenciatura');
  const $buscador = $('#buscador-' + lic);
  const $collapse = $('#' + lic);

  $('.buscador-licenciatura').not($buscador).removeClass('activo');
  $buscador.toggleClass('activo');

  if (!$collapse.hasClass('show')) {
    $collapse.collapse('show');
  }

  $buscador.find('.input-busqueda-local').val('');
  $('.fila-' + lic).show();
  $buscador.find('.sin-resultados-local').hide();
});

$('.input-busqueda-local').on('input', async function () {
  const lic = $(this).data('licenciatura');
  const filtro = $(this).val().toLowerCase();
  const $buscador = $('#buscador-' + lic);
  const $alerta = $buscador.find('.sin-resultados-local');
  let encontrados = 0;

  const $objetivo = $('.fila-' + lic).filter(function () {
    const visible = $(this).text().toLowerCase().includes(filtro);
    $(this).toggle(visible);
    if (visible) encontrados++;
    return visible;
  }).first();

  $alerta.toggle(encontrados === 0);

  if (!filtro || encontrados === 0 || !animacionActiva) return;

  const idSemestre = $objetivo.closest('div[id^="' + lic + '_"]').attr('id');
  const $semestre = $('#' + idSemestre);
  const $licenciatura = $('#' + lic);

  if (!$licenciatura.hasClass('show')) $licenciatura.collapse('show');
  await esperarVisible($licenciatura);

  if (!$semestre.hasClass('show')) $semestre.collapse('show');
  const visibleSemestre = await esperarVisible($semestre);

  if (!visibleSemestre) {
    $buscador.prepend(`
      <div class="alert alert-info alerta-scroll-fallido py-1 px-2 mb-2 text-center small">
        Despliega manualmente el semestre para ver el resultado.
      </div>
    `);
    setTimeout(() => $('.alerta-scroll-fallido').fadeOut(500, function () {
      $(this).remove();
    }), 3000);
    return;
  }

  animacionActiva = true;
  
  // Realiza scroll hacia el alumno encontrado
  $('html, body').animate({
    scrollTop: $objetivo.offset().top - 100
  }, 500, () => {
    $('.table-warning').removeClass('table-warning'); // üîπ Elimina resaltados anteriores
    $objetivo.addClass('table-warning');              // üî∏ Aplica nuevo resaltado
    setTimeout(() => {
      $objetivo.removeClass('table-warning');
    }, 1500);
  });
});

function esperarVisible($elem, intentos = 0) {
  return new Promise(resolve => {
    const check = setInterval(() => {
      const visible = $elem.is(':visible') && $elem[0].scrollHeight > 0;
      if (visible || intentos++ > 20) {
        clearInterval(check);
        resolve(visible);
      }
    }, 50);
  });
}

// üîÑ Ocultar buscadores al hacer clic fuera
$(document).on('click', function (e) {
  if (!$(e.target).closest('.lupa-area').length) {
    $('.buscador-licenciatura').removeClass('activo');
  }
});

// üîÑ Girar flechas de acorde√≥n
$('.collapse').on('show.bs.collapse', function () {
  $(this).prev().find('.rotate-icon').addClass('rotado');
}).on('hide.bs.collapse', function () {
  $(this).prev().find('.rotate-icon').removeClass('rotado');
});

// üî• Eliminar alumno v√≠a AJAX
$('.eliminar-alumno').on('click', function () {
  const id = $(this).data('id');
  const $fila = $('#alumno-' + id);

  if (!confirm('¬øDeseas eliminar a este alumno?')) return;

  fetch('{{ url_for("delete_alumno") }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: new URLSearchParams({ id })
  })
  .then(res => {
    if (res.ok) {
      $fila.fadeOut(300, () => $fila.remove());
      $('#alerta-eliminado').fadeIn(300).delay(1500).fadeOut(500);
    } else {
      alert('‚ùå Error al eliminar el alumno.');
    }
  })
  .catch(() => {
    alert('‚ö†Ô∏è No se pudo conectar con el servidor.');
  });
});

// üß† Avanzar semestre de todos los alumnos de cierta licenciatura
$('.actualizar-semestre').on('click', function () {
  const licenciatura = $(this).data('licenciatura');

  const semestreActual = prompt(`¬øCu√°l es el semestre actual que cursan los alumnos de "${licenciatura}"?`, '');
  if (!semestreActual) return;

  const semestreDestino = prompt(`¬øA qu√© semestre quieres actualizar a los alumnos de "${licenciatura}" que est√°n en el semestre ${semestreActual}?`, '');
  if (!semestreDestino) return;

  if (!confirm(`¬øEst√°s seguro de que quieres cambiar a los alumnos de ${licenciatura} del semestre ${semestreActual} al semestre ${semestreDestino}?`)) return;

  fetch('{{ url_for("actualizar_semestre_alumnos") }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: new URLSearchParams({
      licenciatura,
      semestre_actual: semestreActual,
      semestre_destino: semestreDestino
    })
  })
  .then(res => {
    if (res.ok) {
      alert('‚úÖ Semestre actualizado con √©xito. Recarga la p√°gina en caso de no ver los cambios.');
      location.reload();
    } else if (res.status === 404) {
      alert('‚ö†Ô∏è No se encontraron alumnos en ese semestre con esa licenciatura.');
    } else {
      alert('‚ùå Hubo un error al actualizar los alumnos.');
    }
  })
  .catch(() => alert('‚ùå No se pudo conectar con el servidor.'));
});
</script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
