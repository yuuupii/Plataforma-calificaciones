<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Historial Acad√©mico</title>

  <!-- BOOTSTRAP -->
  <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet"
        href="{{ url_for('static', filename='css/parametros.css') }}">

  <!-- jsPDF + html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* -------------------------
       Estilos generales
    ------------------------- */
    body {
      transition: background 0.35s ease, color 0.35s ease;
    }
    .fade-in { opacity: 0; animation: fadeIn 0.6s forwards; }
    @keyframes fadeIn { to { opacity: 1; } }

    /* Dark mode */
    body.dark-mode { background: #0f1113; color: #e6eef6; }
    .dark-mode .card { background: #121316; border-color: #222; }
    .dark-mode .card-header { background: #1a1c1f; color: #fff; }
    .dark-mode .grafica-wrapper { background: #0f1113; box-shadow: 0 3px 8px rgba(255,255,255,0.03); }

    .card { transition: transform .22s ease, box-shadow .22s ease; }
    .card:hover { transform: translateY(-4px); box-shadow: 0 8px 22px rgba(0,0,0,0.12); }

    .grafica-wrapper {
      max-width: 980px;
      margin: 32px auto;
      padding: 22px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
      transition: background .35s ease;
    }
    body.dark-mode .grafica-wrapper { background: #121416; }

    /* Bot√≥n flotante ‚öôÔ∏è */
    .fab {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 1050;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
      cursor: pointer;
    }
    .fab.btn { padding: 0; }

    /* inputs de color en modal */
    .color-input { width: 48px; height: 32px; border: none; padding: 0; }

    /* responsive */
    @media (max-width: 576px) {
      .grafica-wrapper { padding: 12px; margin: 16px; }
    }
  </style>
</head>

<body class="fade-in">

<div class="container-fluid mt-4">

  <!-- BOTONES SUPERIORES -->
  <div class="text-center mb-3">
    <button id="toggle-dark" class="btn btn-outline-secondary mr-2">üåô Modo oscuro</button>
    <button id="btnPDF" class="btn btn-danger mr-2">üì• Descargar PDF</button>
    <button id="btnIMG" class="btn btn-info">üñº Descargar gr√°fica</button>
  </div>

  <h2 class="text-center mb-3">Historial Acad√©mico</h2>
  {% if estudiante %}
    <h5 class="text-center text-muted mb-3">Estudiante: {{ estudiante }}</h5>
  {% endif %}

  <!-- Contenido del historial -->
  {% if historial %}
    {% for licenciatura, semestres in historial.items() %}
      <div class="card mb-3 fade-in">
        <div class="card-header bg-primary text-white font-weight-bold">
          {{ licenciatura }}
        </div>
        <div class="card-body">
          <div class="row">
            {% for semestre, materias in semestres|dictsort %}
              <div class="col-md-6 col-lg-4 mb-3">
                <div class="border rounded p-3 h-100">
                  <h5 class="text-info">Semestre {{ semestre }}</h5>
                  {% if materias %}
                    <ul class="list-group list-group-flush mb-2">
                      {% for m in materias %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          {{ m.materia }}
                          <span class="badge badge-secondary">{{ m.calificacion }}</span>
                        </li>
                      {% endfor %}
                    </ul>
                    <div class="text-right font-weight-bold text-success">
                      Promedio: {{ promedios_por_semestre[semestre] }}
                    </div>
                  {% else %}
                    <p class="text-muted">Sin calificaciones registradas.</p>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-muted text-center">No hay historial acad√©mico disponible.</p>
  {% endif %}

  <div class="text-center mt-3">
    <a href="{{ url_for('mostrar_calificaciones') }}" class="btn btn-outline-secondary">Volver a Calificaciones</a>
  </div>

  <!-- Datos JSON para JS (evita problemas de plantillas dentro de JS) -->
  {% if promedios_por_semestre %}
  <script id="data-semestres" type="application/json">
    {{ promedios_por_semestre.keys() | list | tojson }}
  </script>
  <script id="data-promedios" type="application/json">
    {{ promedios_por_semestre.values() | list | tojson }}
  </script>

  <div class="grafica-wrapper fade-in">
    <h5 class="text-center mb-3">üìä Evoluci√≥n del Promedio por Semestre</h5>
    <canvas id="graficaPromedios" height="160" aria-label="Gr√°fico de promedios por semestre"></canvas>
  </div>
  {% endif %}
</div>

<!-- Bot√≥n flotante para abrir modal de paleta/colores -->
<button class="btn btn-light fab" id="openSettings" title="Ajustes de gr√°fica (colores)">
  <span style="font-size:20px;">‚öôÔ∏è</span>
</button>

<!-- Modal: ajustes de colores -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="settingsModalLabel">Ajustes de colores - Gr√°fica</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Selecciona un <strong>color base</strong> y la paleta autom√°tica generar√° colores para cada barra. Tambi√©n puedes modificar colores individuales.</p>

        <div class="form-row align-items-center mb-3">
          <div class="col-auto">
            <label class="sr-only" for="baseColor">Color base</label>
            <input type="color" id="baseColor" class="form-control form-control-color" value="#28a745" title="Color base">
          </div>
          <div class="col">
            <button id="applyPalette" class="btn btn-primary">Aplicar paleta autom√°tica</button>
            <button id="resetColors" class="btn btn-outline-secondary">Restablecer por defecto</button>
          </div>
        </div>

        <hr>

        <div id="perBarColorsContainer">
          <!-- Aqu√≠ JS inyecta inputs de color por barra -->
        </div>

      </div>
      <div class="modal-footer">
        <button id="saveColors" type="button" class="btn btn-success">Guardar colores</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- SCRIPTS -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
/* ============================
   Configuraci√≥n inicial
   ============================ */
const userId = JSON.parse('{{ session["user_id"] | default("null") | tojson | safe }}') || "anon";
const storageKey = 'historial_colors_' + userId;

function supportsLocalStorage() {
  try { return 'localStorage' in window && window.localStorage !== null; } catch (e) { return false; }
}

/* ----------------------------
   Dark mode toggle
   ---------------------------- */
const toggleDarkBtn = document.getElementById('toggle-dark');
toggleDarkBtn.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
  localStorage.setItem('historial_dark', document.body.classList.contains('dark-mode'));
  // actualizar colores si la gr√°fica ya fue creada
  actualizarColoresGrafica();
});

if (localStorage.getItem('historial_dark') === 'true') {
  document.body.classList.add('dark-mode');
}

/* ----------------------------
   PDF / IMG botones
   ---------------------------- */
document.getElementById('btnPDF')?.addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const elemento = document.body;
  const canvas = await html2canvas(elemento, { scale: 2 });
  const imgData = canvas.toDataURL('image/png');
  const pdf = new jsPDF('p', 'mm', 'a4');
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
  pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
  pdf.save('historial_academico.pdf');
});

document.getElementById('btnIMG')?.addEventListener('click', () => {
  const c = document.getElementById('graficaPromedios');
  if (!c) return alert('Gr√°fica no disponible');
  const a = document.createElement('a');
  a.href = c.toDataURL('image/png', 1.0);
  a.download = 'grafica_promedios.png';
  a.click();
});

/* ============================
   Datos (prevenimos errores de plantilla)
   ============================ */
let semestres = [];
let promedios = [];
const elSem = document.getElementById('data-semestres');
const elProm = document.getElementById('data-promedios');
if (elSem && elProm) {
  try {
    semestres = JSON.parse(elSem.textContent || '[]');
    promedios = JSON.parse(elProm.textContent || '[]');
  } catch (e) {
    console.error('Error parseando datos JSON:', e);
  }
}

/* ============================
   Paleta autom√°tica (genera n colores desde un color base)
   - Usamos HSL para crear variaciones
   ============================ */
function hexToHsl(hex) {
  hex = hex.replace('#', '');
  const bigint = parseInt(hex, 16);
  const r = (bigint >> 16) & 255;
  const g = (bigint >> 8) & 255;
  const b = bigint & 255;
  const rPct = r / 255, gPct = g / 255, bPct = b / 255;
  const max = Math.max(rPct, gPct, bPct), min = Math.min(rPct, gPct, bPct);
  let h, s, l = (max + min) / 2;
  if (max === min) h = s = 0;
  else {
    const d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
    switch (max) {
      case rPct: h = (gPct - bPct) / d + (gPct < bPct ? 6 : 0); break;
      case gPct: h = (bPct - rPct) / d + 2; break;
      default: h = (rPct - gPct) / d + 4; break;
    }
    h /= 6;
  }
  return [Math.round(h * 360), Math.round(s * 100), Math.round(l * 100)];
}
function hslToHex(h,s,l){
  s /= 100; l /= 100;
  const k = n => (n + h/30) % 12;
  const a = s * Math.min(l, 1-l);
  const f = n => {
    const c = Math.max(Math.min(k(n)-3, 9 - k(n), 1), -1);
    const color = l - a * c;
    return Math.round(255 * color).toString(16).padStart(2, '0');
  };
  return `#${f(0)}${f(8)}${f(4)}`;
}
function generatePalette(baseHex, count) {
  const [h, s, l] = hexToHsl(baseHex);
  const palette = [];
  // distribuir tonos alrededor del hue base
  const step = Math.max(6, Math.floor(360 / Math.max(6, count)));
  for (let i = 0; i < count; i++) {
    const hue = (h + i * step) % 360;
    const sat = Math.min(85, s + (i%2?6:-4)); // ligera variaci√≥n
    const lig = Math.min(65, Math.max(30, l + (i%2?6:-6)));
    palette.push(hslToHex(hue, sat, lig));
  }
  return palette;
}

/* ============================
   Guardar / recuperar colores (localStorage)
   ============================ */
function saveColorsToStorage(colors) {
  if (!supportsLocalStorage()) return;
  localStorage.setItem(storageKey, JSON.stringify(colors));
}
function loadColorsFromStorage() {
  if (!supportsLocalStorage()) return null;
  const raw = localStorage.getItem(storageKey);
  return raw ? JSON.parse(raw) : null;
}

/* ============================
   Crear gr√°fica (Chart.js)
   - m√°ximo 10
   - animaci√≥n inicial de barras
   - hover: escala y sombra
   ============================ */
let grafica = null;
function crearGrafica(initialColors) {
  const ctx = document.getElementById('graficaPromedios').getContext('2d');
  // generar background con alpha y border
  const backgrounds = initialColors.map(c => hexToRgba(c, 0.55));
  const borders = initialColors.map(c => c);

  grafica = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: semestres.map(s => 'Semestre ' + s),
      datasets: [{
        label: 'Promedio',
        data: promedios,
        backgroundColor: backgrounds,
        borderColor: borders,
        borderWidth: 1.5,
        hoverBorderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 1100, easing: 'easeOutQuart' },
      plugins: {
        legend: { display: false },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 10,
          ticks: { stepSize: 1 }
        }
      },
      onHover: (evt, elements) => {
        // cambia cursor si est√° sobre una barra
        evt.native ? evt.native.target.style.cursor = elements.length ? 'pointer' : 'default' : null;
      }
    }
  });

  // hover anim: agrandar barra y a√±adir sombra (usando plugin Chart.js)
  Chart.defaults.plugins.customHoverGrow = {
    enabled: true
  };
  // plugin para suavizar hover (a√±adir sombra)
  Chart.register({
    id: 'hoverGrow',
    afterDatasetDraw: function(chart) {
      // nada aqu√≠ ‚Äî usamos opciones CSS/transform con canvas no es directo,
      // pero Chart ya muestra hover estilo por defecto; para animaci√≥n extra podemos redibujar.
    }
  });
}

/* helper: convertir hex a rgba */
function hexToRgba(hex, alpha=1) {
  hex = hex.replace('#','');
  const bigint = parseInt(hex,16);
  const r = (bigint >> 16) & 255;
  const g = (bigint >> 8) & 255;
  const b = bigint & 255;
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

/* ============================
   UI de ajustes (modal)
   - muestra inputs por barra con colores actuales
   ============================ */
const openSettings = document.getElementById('openSettings');
const settingsModal = $('#settingsModal');

openSettings.addEventListener('click', () => {
  settingsModal.modal('show');
  buildPerBarColorInputs();
});

function buildPerBarColorInputs() {
  const container = document.getElementById('perBarColorsContainer');
  container.innerHTML = '';
  if (!grafica) return;

  const labels = grafica.data.labels;
  const datasetCols = grafica.data.datasets[0].borderColor.map(c => c);
  labels.forEach((lbl, i) => {
    const row = document.createElement('div');
    row.className = 'form-row align-items-center mb-2';

    const colLabel = document.createElement('div');
    colLabel.className = 'col-auto';
    colLabel.innerHTML = `<strong style="min-width:140px;display:inline-block">${lbl}</strong>`;

    const colInput = document.createElement('div');
    colInput.className = 'col-auto';
    const input = document.createElement('input');
    input.type = 'color';
    input.className = 'color-input';
    input.value = datasetCols[i] || '#888888';
    input.dataset.index = i;
    colInput.appendChild(input);

    const colPreview = document.createElement('div');
    colPreview.className = 'col';
    colPreview.innerHTML = `<small class="text-muted">Color de barra</small>`;

    row.appendChild(colLabel);
    row.appendChild(colInput);
    row.appendChild(colPreview);
    container.appendChild(row);

    // on change: actualizar la barra en tiempo real
    input.addEventListener('input', (ev) => {
      const idx = Number(ev.target.dataset.index);
      const newHex = ev.target.value;
      grafica.data.datasets[0].borderColor[idx] = newHex;
      grafica.data.datasets[0].backgroundColor[idx] = hexToRgba(newHex, 0.55);
      grafica.update('none');
    });
  });
}

/* ----------------------------
   Aplicar paleta autom√°tica desde baseColor
   ---------------------------- */
document.getElementById('applyPalette').addEventListener('click', () => {
  const base = document.getElementById('baseColor').value || '#28a745';
  const count = semestres.length || (promedios.length);
  const pal = generatePalette(base, count);
  // aplicar al chart
  if (grafica) {
    grafica.data.datasets[0].borderColor = pal.slice();
    grafica.data.datasets[0].backgroundColor = pal.map(h=>hexToRgba(h,0.55));
    grafica.update();
  }
  // actualizar inputs si modal abierto
  buildPerBarColorInputs();
});

/* ----------------------------
   Reset colores por defecto (paleta desde color base por defecto)
   ---------------------------- */
document.getElementById('resetColors').addEventListener('click', () => {
  const defaultBase = '#28a745';
  document.getElementById('baseColor').value = defaultBase;
  const pal = generatePalette(defaultBase, semestres.length || promedios.length);
  if (grafica) {
    grafica.data.datasets[0].borderColor = pal.slice();
    grafica.data.datasets[0].backgroundColor = pal.map(h=>hexToRgba(h,0.55));
    grafica.update();
  }
  buildPerBarColorInputs();
});

/* ----------------------------
   Guardar colores (persistir)
   ---------------------------- */
document.getElementById('saveColors').addEventListener('click', () => {
  if (!grafica) return;
  const colors = grafica.data.datasets[0].borderColor.slice();
  saveColorsToStorage(colors);
  settingsModal.modal('hide');
});

/* ----------------------------
   Cargar colores en init (si hay guardados)
   ---------------------------- */
function loadInitialColors() {
  let stored = loadColorsFromStorage();
  if (stored && Array.isArray(stored) && stored.length >= promedios.length) {
    return stored.slice(0, promedios.length);
  }
  // si no hay guardados, generar desde base default
  const baseDefault = document.getElementById('baseColor') ? document.getElementById('baseColor').value : '#28a745';
  return generatePalette(baseDefault, promedios.length);
}

/* ----------------------------
   Actualizar colores segun modo oscuro
   ---------------------------- */
function actualizarColoresGrafica() {
  if (!grafica) return;
  const modoOscuro = document.body.classList.contains('dark-mode');

  // obtener colores base guardados (si existen)
  let current = grafica.data.datasets[0].borderColor.slice();
  // ajustar brillo/tono si modo oscuro: subir luz o cambiar hue (aqu√≠ hacemos una leve aclaraci√≥n)
  const adjusted = current.map(hex => {
    // convertir a HSL y si dark, aumentar lum; si light, dejar
    const [h,s,l] = hexToHsl(hex);
    const lum = modoOscuro ? Math.min(70, l + 6) : Math.max(28, l - 4);
    return hslToHex(h, s, lum);
  });

  grafica.data.datasets[0].borderColor = adjusted;
  grafica.data.datasets[0].backgroundColor = adjusted.map(h => hexToRgba(h, 0.55));
  grafica.update();
}

/* ============================
   Inicializaci√≥n final
   ============================ */
document.addEventListener('DOMContentLoaded', () => {
  if (!semestres.length || !promedios.length) return;
  // cargar colores (persistidos o autom√°ticos)
  const inicial = loadInitialColors();
  // si la longitud no coincide: regenerar paleta
  const colors = (inicial.length === promedios.length) ? inicial : generatePalette(document.getElementById('baseColor').value, promedios.length);

  crearGrafica(colors);

  // si hay colores guardados y modo oscuro activo, ajustar la apariencia
  if (localStorage.getItem('historial_dark') === 'true') {
    actualizarColoresGrafica();
  }
});
</script>
</body>
</html>
