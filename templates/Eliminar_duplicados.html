<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestionar Duplicados de Calificaciones</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/parametros.css') }}">
</head>
<body>
<div class="container mt-4">
    <h1 class="text-center mb-4">Gestionar Duplicados de Calificaciones</h1>

    {% if calificaciones %}
    <form method="POST" action="{{ url_for('eliminar_duplicados') }}" onsubmit="return confirmarEliminacion()">
        <div class="mb-2">
            <button type="submit" class="btn btn-danger">
                Eliminar seleccionados (<span id="contador">0</span>)
            </button>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover">
                <thead class="thead-dark">
                <tr>
                    <th><input type="checkbox" id="check-todo"></th>
                    <th>Estudiante</th>
                    <th>Materia</th>
                    <th>Calificación</th>
                </tr>
                </thead>
                <tbody>
                {% for calificacion in calificaciones %}
                <tr>
                    <td><input type="checkbox" name="duplicados" value="{{ calificacion['id'] }}" class="check-individual"></td>
                    <td>{{ calificacion['estudiante_nombre'] }}</td>
                    <td>{{ calificacion['materia_nombre'] }}</td>
                    <td>{{ calificacion['calificacion'] }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </form>
    {% else %}
    <div class="alert alert-info text-center">No se encontraron calificaciones duplicadas.</div>
    {% endif %}
</div>

<script>
    const checkTodo = document.getElementById('check-todo');
    const checkboxes = document.querySelectorAll('.check-individual');
    const contador = document.getElementById('contador');

    function actualizarContador() {
        const seleccionados = document.querySelectorAll('.check-individual:checked').length;
        contador.textContent = seleccionados;
    }

    checkTodo?.addEventListener('change', function () {
        checkboxes.forEach(cb => cb.checked = this.checked);
        actualizarContador();
    });

    checkboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            if (!cb.checked) checkTodo.checked = false;
            if (document.querySelectorAll('.check-individual:checked').length === checkboxes.length) {
                checkTodo.checked = true;
            }
            actualizarContador();
        });
    });

    function confirmarEliminacion() {
        const seleccionados = document.querySelectorAll('.check-individual:checked').length;
        if (seleccionados === 0) {
            alert("Por favor selecciona al menos una calificación para eliminar.");
            return false;
        }
        return confirm(`¿Estás seguro de eliminar ${seleccionados} calificación(es) duplicada(s)?`);
    }
</script>
</body>
</html>